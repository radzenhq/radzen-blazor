@using System.IO
@using Radzen.Blazor
@inject ExampleService ExampleService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>@ExampleService.TitleFor(example)</PageTitle>
<HeadContent>
    <meta name="description" content="@ExampleService.DescriptionFor(example)">
</HeadContent>
@if (Heading)
{
    <h1>@Name</h1>
    <p>Demonstration and configuration of the Radzen Blazor <strong>@Name</strong> component.</p>
}
<div class="documentation-links">
@if (Documentation)
{
    <a target="blank" href="@DocumentationHref" title=@($"Open {Name} documentation in new tab") ><RadzenIcon Icon="help_outline" style="font-size: 1rem; margin-right: 4px;" /> @Name Docs</a>
}
@if (Heading)
{
    <a target="blank" href="@ComponentSourceHref" title=@($"View {Name} source code in new tab") ><RadzenIcon Icon="launch" style="font-size: 1rem; margin-right: 4px;" /> @Name Source</a>
}
</div>
<RadzenTabs RenderMode="TabRenderMode.Server" Change=@OnChange>
    <Tabs>
        <RadzenTabsItem Text="Example" Icon="apps">
            @if (!string.IsNullOrEmpty(error))
            {
                @((MarkupString)error)
            }
            else if(RuntimeChildContent != null)
            {
                @RuntimeChildContent
            }
            else
            {
                @ChildContent
            }
        </RadzenTabsItem>
        <RadzenTabsItem Text="Source" Icon="code">
            <CodeViewer @ref="codeViewer" PageName="@($"{Source ?? Name}Page.razor")" />
        </RadzenTabsItem>
        @foreach (var p in AdditionalSourceCodePages)
        {
        <RadzenTabsItem Text="@Path.GetFileName(p)" Icon="code">
            <CodeViewer PageName="@p" />
        </RadzenTabsItem>
        }
    </Tabs>
</RadzenTabs>

@code {
    [Parameter]
    public RenderFragment ChildContent { get; set; }

    [Parameter]
    public string Name { get; set; }

    [Parameter]
    public string Source { get; set; }

    [Parameter]
    public bool Heading { get; set; } = true;

    [Parameter]
    public bool Documentation { get; set; } = true;

    string DocumentationHref => $"/docs/guides/components/{Name.ToLower()}.html";

    string ComponentSourceHref => $"https://github.com/radzenhq/radzen-blazor/blob/master/Radzen.Blazor/Radzen{Name}.razor.cs";

    [Parameter]
    public IEnumerable<string> AdditionalSourceCodePages { get; set; } = Enumerable.Empty<string>();

    Example example;

    protected override void OnInitialized()
    {
        example = ExampleService.FindCurrent(NavigationManager.ToAbsoluteUri(NavigationManager.Uri));
    }

    CodeViewer codeViewer;
    RenderFragment RuntimeChildContent;
    string error;
    async Task OnChange(int index)
    {
        if (index == 0)
        {
            var originalSource = codeViewer.GetOriginalSource();
            var newSource = await JSRuntime.InvokeAsync<string>("getEditorValue");
            if (!String.IsNullOrEmpty(newSource) && newSource != originalSource)
            {
                var compiler = new Compiler();
                Type compiledType = null;

                try
                {
                    compiledType = compiler.Compile(newSource);
                }
                catch(Exception ex)
                {
                    error = ex.Message;
                }

                if (compiledType != null)
                {
                    RuntimeChildContent = new RenderFragment(builder =>
                    {
                        builder.OpenComponent(0, compiledType);

                        builder.CloseComponent();
                    });
                }
            }
        }
    }
}