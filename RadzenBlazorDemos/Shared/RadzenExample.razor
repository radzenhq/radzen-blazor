@using System.IO
@using Radzen.Blazor
@implements IDisposable
@inject ExampleService ExampleService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>@ExampleService.TitleFor(example)</PageTitle>
<HeadContent>
    <meta name="description" content="@ExampleService.DescriptionFor(example)">
</HeadContent>
@if (Heading)
{
    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" Class="my-4">
        @Name
    </RadzenText>
    <RadzenText TextStyle="TextStyle.Body1" Class="my-4">
        Demonstration and configuration of the Radzen Blazor <strong>@Name</strong> component.
    </RadzenText>
}
<div class="documentation-links">
@if (Documentation)
{
    <a target="blank" href="@DocumentationHref" title=@($"Open {Name} documentation in new tab") ><RadzenIcon Icon="launch" style="font-size: 1rem; margin-right: 4px;" /> @Name Docs</a>
}
@if (Heading)
{
    <a target="blank" href="@ComponentSourceHref" title=@($"View {Name} source code in new tab") ><RadzenIcon Icon="launch" style="font-size: 1rem; margin-right: 4px;" /> @Name Source</a>
}
</div>
<RadzenTabs @bind-SelectedIndex="@selectedIndex">
    <Tabs>
        <RadzenTabsItem Text="Example" Icon="apps">
            @(dynamicContent ?? ChildContent)
        </RadzenTabsItem>
        <RadzenTabsItem Text="Source" Icon="code">
            <CodeViewer PageName="@ExampleUrl" Compiled="OnCompiled" />
        </RadzenTabsItem>
        @foreach (var p in AdditionalSourceCodePages)
        {
        <RadzenTabsItem Text="@Path.GetFileName(p)" Icon="code">
            <CodeViewer PageName="@p" />
        </RadzenTabsItem>
        }
    </Tabs>
</RadzenTabs>

@code {

    private int selectedIndex = 0;
}

@code {

    private RenderFragment dynamicContent;
}

@code {

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    [Parameter]
    public string Name { get; set; }

    [Parameter]
    public string Source { get; set; }

    [Parameter]
    public string Example { get; set; }

    [Parameter]
    public string DocumentationLink { get; set; }

    [Parameter]
    public bool Heading { get; set; } = true;

    [Parameter]
    public bool Documentation { get; set; } = true;

    string DocumentationHref => DocumentationLink ?? $"/docs/guides/components/{Name.ToLower()}.html";

    string ComponentSourceHref => Source ?? $"https://github.com/radzenhq/radzen-blazor/blob/master/Radzen.Blazor/Radzen{Name}.razor.cs";

    [Parameter]
    public IEnumerable<string> AdditionalSourceCodePages { get; set; } = Enumerable.Empty<string>();

    private string ExampleUrl => string.IsNullOrEmpty(Example) ? $"{Name}Page.razor" : $"{Example}.razor";

    Example example;

    DateTime start;

    protected override void OnInitialized()
    {
        start = DateTime.Now;

        example = ExampleService.FindCurrent(NavigationManager.ToAbsoluteUri(NavigationManager.Uri));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", $"console.log('Page {Name} render time is {(DateTime.Now - start).TotalMilliseconds} ms')");
        }
    }

    void OnCompiled(Type type)
    {
        dynamicContent = builder =>
        {
            builder.OpenComponent(0, type);
            builder.CloseComponent();
        };

        selectedIndex = 0;
    }

    public void Dispose()
    {
        GC.Collect();
    }
}