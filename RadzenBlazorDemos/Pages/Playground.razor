@page "/playground"
@page "/playground/{Id}"
@layout PlaygroundLayout
@using System.Text.RegularExpressions
@using System.Text.Json
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.WebAssembly.Services
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IServiceProvider ServiceProvider
@implements IDisposable

<PageTitle>Playground | Radzen Blazor Components</PageTitle>

<RadzenText TextStyle="TextStyle.H2" TagName="TagName.H1" class="rz-pt-8">
    Playground
</RadzenText>
<RadzenText TextStyle="TextStyle.Subtitle1" TagName="TagName.P" class="rz-pb-4">
    Edit and run Blazor code in real-time.
</RadzenText>

<RadzenRow class="rz-pb-4" Gap="0.5rem">
    <RadzenColumn>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0.5rem">
            <RadzenButton IsBusy=@isBusy Disabled=@isBusy Click="Run" Text="Run" Icon="play_circle" ButtonStyle="ButtonStyle.Primary" />
            <RadzenButton IsBusy=@isSaving Disabled=@(isBusy || isSaving) Click="Save" Text="Save" Icon="save" ButtonStyle="ButtonStyle.Secondary" />
        </RadzenStack>
    </RadzenColumn>
</RadzenRow>

<RadzenAlert Visible=@(error != null) AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" class="rz-mb-4">@error</RadzenAlert>
<RadzenAlert Visible=@(saveSuccess) AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter" class="rz-mb-4">
    Snippet saved! Share this URL: @currentUrl
    <RadzenButton Click="CopyUrl" Text="Copy" Icon="content_copy" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.ExtraSmall" Variant="Variant.Text" class="rz-ms-2" />
</RadzenAlert>

<RadzenSplitter Orientation="Orientation.Horizontal" style="height: calc(100vh - 300px); min-height: 400px; border: 1px solid var(--rz-border-color);">
    <RadzenSplitterPane Size="50%" Min="300px">
        <div class="rz-p-0" style="height: 100%; display: flex; flex-direction: column;">
            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-p-2 rz-m-0" style="border-bottom: 1px solid var(--rz-border-color);">
                Source Code
            </RadzenText>
            <div style="flex: 1; min-height: 0;">
                <Monaco @ref="monaco" Value="@source" ValueChanged="OnValueChanged" Language="razor" Style="height: 100%; width: 100%;" />
            </div>
        </div>
    </RadzenSplitterPane>
    <RadzenSplitterPane Min="300px">
        <div class="rz-p-0" style="height: 100%; display: flex; flex-direction: column; overflow: auto;">
            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-p-2 rz-m-0" style="border-bottom: 1px solid var(--rz-border-color);">
                Preview
            </RadzenText>
            <div class="rz-p-4" style="flex: 1; overflow: auto;">
                @if (dynamicContent != null)
                {
                    @dynamicContent
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-text-disabled-color">
                        Click "Run" to preview your code.
                    </RadzenText>
                }
            </div>
        </div>
    </RadzenSplitterPane>
</RadzenSplitter>

@code {
    private Monaco monaco;
    private string source = DefaultSource;
    private string error;
    private bool isBusy;
    private bool isSaving;
    private bool saveSuccess;
    private string currentUrl;
    private RenderFragment dynamicContent;
    private ICompilerService compiler;
    private string editToken;

    private const string DefaultSource = @"<RadzenButton Text=""Hello World!"" Click=""@OnClick"" />
<RadzenText TextStyle=""TextStyle.Body1"" class=""rz-mt-4"">@message</RadzenText>

@code {
    string message = ""Click the button above!"";

    void OnClick()
    {
        message = $""Button clicked at {DateTime.Now:HH:mm:ss}"";
    }
}";

    [Parameter]
    public string Id { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public string Example { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Load from saved snippet if Id is provided
        if (!string.IsNullOrEmpty(Id))
        {
            await LoadSnippetAsync(Id);
        }
        // Load from example if Example query param is provided
        else if (!string.IsNullOrEmpty(Example))
        {
            await LoadExampleAsync(Example);
        }
    }

    async Task LoadSnippetAsync(string id)
    {
        try
        {
            var response = await Http.GetAsync($"/api/playground/{id}");
            if (response.IsSuccessStatusCode)
            {
                var snippet = await response.Content.ReadFromJsonAsync<SnippetResponse>();
                if (snippet != null)
                {
                    source = snippet.Source;
                    // Try to get the edit token from localStorage
                    editToken = await GetEditTokenAsync(id);
                }
            }
        }
        catch
        {
            // Use default source if snippet cannot be loaded
        }
    }

    async Task LoadExampleAsync(string example)
    {
        try
        {
            var exampleSource = await Http.GetStringAsync($"/demos/Pages/{example}.txt");
            source = Clean(exampleSource);
        }
        catch
        {
            // Use default source if example cannot be loaded
        }
    }

    string Clean(string source)
    {
        return Regex.Replace(source, "</?RadzenExample[^>]*>\n?", "");
    }

    void OnValueChanged(string value)
    {
        source = value;
        saveSuccess = false;
    }

    async Task Run()
    {
        try
        {
            error = null;
            isBusy = true;
            StateHasChanged();

            await Task.Yield();

            await EnsureCompilerAsync();

            var type = await compiler.CompileAsync(source);

            dynamicContent = builder =>
            {
                builder.OpenComponent(0, type);
                builder.CloseComponent();
            };
        }
        catch (Exception ex)
        {
            error = ex.Message;
            dynamicContent = null;
        }
        finally
        {
            isBusy = false;
        }
    }

    async Task Save()
    {
        try
        {
            error = null;
            saveSuccess = false;
            isSaving = true;
            StateHasChanged();

            var request = new
            {
                id = Id,
                source = source,
                editToken = editToken
            };

            var response = await Http.PostAsJsonAsync("/api/playground/save", request);
            
            if (!response.IsSuccessStatusCode)
            {
                var errorResponse = await response.Content.ReadAsStringAsync();
                throw new Exception($"Failed to save: {errorResponse}");
            }

            var result = await response.Content.ReadFromJsonAsync<SaveResponse>();
            
            if (result != null)
            {
                // Store the edit token in localStorage
                await SetEditTokenAsync(result.Id, result.EditToken);
                editToken = result.EditToken;

                // Navigate to the new URL if it's a new snippet or clone
                if (result.IsNew || Id != result.Id)
                {
                    Id = result.Id;
                    NavigationManager.NavigateTo($"/playground/{result.Id}", replace: false);
                }

                currentUrl = NavigationManager.ToAbsoluteUri($"/playground/{result.Id}").ToString();
                saveSuccess = true;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    async Task CopyUrl()
    {
        if (!string.IsNullOrEmpty(currentUrl))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", currentUrl);
        }
    }

    async Task<string> GetEditTokenAsync(string id)
    {
        try
        {
            return await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"playground-token-{id}");
        }
        catch
        {
            return null;
        }
    }

    async Task SetEditTokenAsync(string id, string token)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", $"playground-token-{id}", token);
        }
        catch
        {
            // Ignore localStorage errors
        }
    }

    async Task EnsureCompilerAsync()
    {
        if (compiler != null)
        {
            return;
        }

        var assemblyLoader = ServiceProvider.GetService(typeof(LazyAssemblyLoader)) as LazyAssemblyLoader;

        if (assemblyLoader != null)
        {
            await assemblyLoader.LoadAssembliesAsync(new[]
            {
                "Microsoft.CodeAnalysis.dll",
                "Microsoft.CodeAnalysis.CSharp.dll",
                "Microsoft.CodeAnalysis.Razor.dll",
                "Microsoft.AspNetCore.Razor.Language.dll",
                "Microsoft.AspNetCore.Mvc.Razor.Extensions.dll",
                "MetadataReferenceService.BlazorWasm.dll",
                "MetadataReferenceService.Abstractions.dll"
            });
        }

        var compilerType = AppDomain.CurrentDomain.GetAssemblies()
            .Select(a => a.GetType("RadzenBlazorDemos.CompilerService", false))
            .FirstOrDefault(t => t != null);
        
        compiler = (ICompilerService)Activator.CreateInstance(compilerType, NavigationManager);
    }

    public void Dispose()
    {
        GC.Collect();
    }

    class SnippetResponse
    {
        public string Id { get; set; }
        public string Source { get; set; }
        public string ParentId { get; set; }
    }

    class SaveResponse
    {
        public string Id { get; set; }
        public string EditToken { get; set; }
        public bool IsNew { get; set; }
    }
}
